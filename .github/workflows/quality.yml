name: Code Quality

"on":
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  pre-commit:
    name: Pre-commit Hooks
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install pre-commit
        run: |
          python -m pip install --upgrade pip
          pip install pre-commit

      - name: Run pre-commit hooks
        run: |
          pre-commit run --all-files --show-diff-on-failure

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install audit tools
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit bandit[toml]

      - name: Audit dependencies for vulnerabilities
        continue-on-error: true
        run: |
          pip-audit --requirement requirements.txt --format=table

      - name: Run security linting with Bandit
        run: |
          bandit -r homodyne/ --configfile pyproject.toml --severity-level medium

  type-check:
    name: Type Checking (Relaxed)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install mypy types-psutil types-requests

      - name: Run MyPy type checking
        continue-on-error: true
        run: |
          echo "Running relaxed MyPy for scientific computing..."
          mypy homodyne/ --config-file pyproject.toml --show-error-codes || echo "Type checking completed with expected warnings"

  format-check:
    name: Format and Style Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install formatting tools
        run: |
          python -m pip install --upgrade pip
          pip install black isort ruff

      - name: Check code formatting with Black
        run: |
          black --check --diff homodyne/

      - name: Check import sorting with isort
        run: |
          isort --check-only --diff --profile black homodyne/

      - name: Run Ruff linter
        run: |
          ruff check homodyne/ --output-format=github