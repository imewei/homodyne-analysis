name: ğŸ” Code Quality Monitoring

on:
  push:
    branches: [main, develop]
    paths:
      - 'homodyne/**/*.py'
      - 'pyproject.toml'
      - 'requirements*.txt'
      - '.github/workflows/quality-monitoring.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'homodyne/**/*.py'
      - 'pyproject.toml'
      - 'requirements*.txt'
      - '.github/workflows/quality-monitoring.yml'
  schedule:
    # Run quality checks daily at 2 AM UTC
    - cron: '0 2 * * *'

env:
  PYTHON_VERSION: '3.13'
  POETRY_VERSION: '1.8.0'

jobs:
  quality-analysis:
    name: ğŸ”¬ Comprehensive Quality Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for better analysis

    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        cache-dependency-path: |
          pyproject.toml
          requirements*.txt

    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    - name: ğŸ§¹ Code Formatting Check
      run: |
        echo "::group::ğŸ¨ Ruff Format Check"
        ruff format --check --diff homodyne/
        echo "::endgroup::"
        
        echo "::group::ğŸ”§ Black Format Check"  
        black --check --diff homodyne/
        echo "::endgroup::"

    - name: ğŸ“Š Linting Analysis
      run: |
        echo "::group::âš¡ Ruff Linting"
        ruff check homodyne/ --output-format=github
        echo "::endgroup::"
        
        echo "::group::ğŸ” Additional Linting"
        # Allow non-zero exit codes for reporting but continue workflow
        pylint homodyne/ --output-format=colorized --reports=y --score=y || true
        echo "::endgroup::"

    - name: ğŸ” Security Analysis
      run: |
        echo "::group::ğŸ›¡ï¸ Bandit Security Scan"
        bandit -r homodyne/ -f json -o bandit-report.json -ll
        
        # Pretty print summary for logs
        echo "=== Security Analysis Summary ==="
        jq '.metrics._totals' bandit-report.json || echo "No security issues found"
        echo "::endgroup::"

    - name: ğŸ”¤ Type Checking
      run: |
        echo "::group::ğŸ“ MyPy Type Analysis"
        mypy homodyne/ --show-error-codes --no-error-summary --ignore-missing-imports || true
        echo "::endgroup::"

    - name: ğŸ§ª Fast Test Suite
      run: |
        echo "::group::âš¡ Fast Quality Tests"
        pytest -m "not slow and not integration" \
               --tb=short \
               --maxfail=3 \
               -x \
               -q \
               --cov=homodyne \
               --cov-report=xml \
               --cov-report=term-missing:skip-covered
        echo "::endgroup::"

    - name: ğŸ“ˆ Performance Benchmarks
      run: |
        echo "::group::ğŸƒ Performance Testing"
        if [ -f scripts/run_performance_tests.py ]; then
          python scripts/run_performance_tests.py --ci --verbose || echo "âš ï¸ Performance tests completed with warnings"
        else
          echo "âš ï¸ Performance test script not found, skipping benchmarks"
        fi
        echo "::endgroup::"

    - name: ğŸ“Š Upload Coverage
      uses: codecov/codecov-action@v4
      if: success()
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-homodyne

    - name: ğŸ“‹ Generate Quality Report
      if: always()
      run: |
        echo "::group::ğŸ“Š Quality Metrics Summary"
        echo "## ğŸ” Code Quality Analysis Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Lines of code
        echo "**ğŸ“ Code Metrics:**" >> $GITHUB_STEP_SUMMARY
        echo "- Total Python files: $(find homodyne/ -name '*.py' | wc -l)" >> $GITHUB_STEP_SUMMARY
        echo "- Lines of code: $(find homodyne/ -name '*.py' -exec wc -l {} + | tail -1 | awk '{print $1}')" >> $GITHUB_STEP_SUMMARY
        
        # Security summary
        if [ -f bandit-report.json ]; then
          HIGH_ISSUES=$(jq '.metrics._totals."SEVERITY.HIGH" // 0' bandit-report.json)
          MEDIUM_ISSUES=$(jq '.metrics._totals."SEVERITY.MEDIUM" // 0' bandit-report.json)  
          LOW_ISSUES=$(jq '.metrics._totals."SEVERITY.LOW" // 0' bandit-report.json)
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ğŸ›¡ï¸ Security Analysis:**" >> $GITHUB_STEP_SUMMARY
          echo "- High severity: $HIGH_ISSUES" >> $GITHUB_STEP_SUMMARY
          echo "- Medium severity: $MEDIUM_ISSUES" >> $GITHUB_STEP_SUMMARY
          echo "- Low severity: $LOW_ISSUES" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**âœ… Quality Status:** Analysis Complete" >> $GITHUB_STEP_SUMMARY
        echo "::endgroup::"

    - name: ğŸ’¾ Archive Quality Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: quality-reports-${{ github.sha }}
        path: |
          bandit-report.json
          coverage.xml
          homodyne/tests/performance_baselines.json
        retention-days: 30

  type-coverage-analysis:
    name: ğŸ“ Type Coverage Analysis  
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        cache-dependency-path: |
          pyproject.toml
          requirements*.txt

    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    - name: ğŸ“Š Advanced Type Analysis
      run: |
        echo "::group::ğŸ” Type Coverage Report"
        
        # Generate detailed type coverage
        mypy homodyne/ \
          --html-report mypy-report \
          --show-error-codes \
          --ignore-missing-imports \
          --strict-optional || true
          
        echo "Type analysis complete - see artifacts for detailed report"
        echo "::endgroup::"

    - name: ğŸ’¾ Upload Type Reports
      uses: actions/upload-artifact@v4
      with:
        name: type-coverage-${{ github.sha }}
        path: mypy-report/
        retention-days: 14

  dependency-analysis:
    name: ğŸ“¦ Dependency Security & Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 8

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        cache-dependency-path: |
          pyproject.toml
          requirements*.txt

    - name: ğŸ” Dependency Security Audit
      run: |
        pip install pip-audit safety
        
        echo "::group::ğŸ” Pip Audit"
        pip-audit --format=json --output=pip-audit.json || true
        pip-audit --format=text || true
        echo "::endgroup::"
        
        echo "::group::ğŸ›¡ï¸ Safety Check"
        safety check --json --output=safety-report.json || true
        safety check || true
        echo "::endgroup::"

    - name: ğŸ“Š License Compliance
      run: |
        pip install pip-licenses
        
        echo "::group::ğŸ“„ License Analysis"
        pip-licenses --format=json --output-file=licenses.json
        pip-licenses --summary
        echo "::endgroup::"

    - name: ğŸ’¾ Upload Dependency Reports
      uses: actions/upload-artifact@v4
      with:
        name: dependency-analysis-${{ github.sha }}
        path: |
          pip-audit.json
          safety-report.json
          licenses.json

  performance-regression:
    name: ğŸƒ Performance Regression Detection
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event_name == 'pull_request'

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        cache-dependency-path: |
          pyproject.toml
          requirements*.txt

    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"
        pip install pytest-benchmark

    - name: ğŸƒ Run Baseline Benchmarks
      run: |
        echo "::group::ğŸ“Š Performance Baseline"
        # Fetch main branch for comparison
        git fetch origin main:baseline-main
        git stash --include-untracked
        git checkout baseline-main
        if [ -f scripts/run_performance_tests.py ]; then
          python scripts/run_performance_tests.py --update-baselines --verbose || true
          cp homodyne/tests/performance_baselines.json baseline_main.json 2>/dev/null || echo "No baseline file created"
        else
          echo "Performance test script not found, creating empty baseline"
          echo '{"baseline_date": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"}' > baseline_main.json
        fi
        echo "::endgroup::"

    - name: ğŸ”„ Run Current Branch Benchmarks  
      run: |
        echo "::group::ğŸš€ Current Branch Performance"
        # Return to the original state
        git checkout ${{ github.sha }}
        git stash pop || true
        if [ -f scripts/run_performance_tests.py ]; then
          python scripts/run_performance_tests.py --verbose || true
        else
          echo "Performance test script not found, creating minimal baseline"
          mkdir -p homodyne/tests/
          echo '{"baseline_date": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"}' > homodyne/tests/performance_baselines.json
        fi
        echo "::endgroup::"

    - name: ğŸ“Š Compare Performance
      run: |
        echo "::group::âš–ï¸ Performance Comparison"
        python -c "
import json
import sys

with open('baseline_main.json') as f:
    baseline = json.load(f)
    
with open('homodyne/tests/performance_baselines.json') as f:
    current = json.load(f)

print('=== Performance Regression Analysis ===')
print(f'Baseline: {baseline.get(\"baseline_date\", \"unknown\")}')
print(f'Current:  {current.get(\"baseline_date\", \"unknown\")}')
print()

# Add regression detection logic here
print('Performance analysis complete - detailed results in artifacts')
"
        echo "::endgroup::"

  quality-gate:
    name: ğŸšª Quality Gate Check
    runs-on: ubuntu-latest
    needs: [quality-analysis, type-coverage-analysis, dependency-analysis]
    if: always()

    steps:
    - name: ğŸ¯ Evaluate Quality Gate
      run: |
        echo "::group::ğŸšª Quality Gate Evaluation"
        
        QUALITY_STATUS="${{ needs.quality-analysis.result }}"
        TYPE_STATUS="${{ needs.type-coverage-analysis.result }}"
        DEPENDENCY_STATUS="${{ needs.dependency-analysis.result }}"
        
        echo "Quality Analysis: $QUALITY_STATUS"
        echo "Type Coverage: $TYPE_STATUS"  
        echo "Dependency Analysis: $DEPENDENCY_STATUS"
        
        # Determine overall quality gate status
        if [[ "$QUALITY_STATUS" == "success" && "$TYPE_STATUS" == "success" && "$DEPENDENCY_STATUS" == "success" ]]; then
          echo "âœ… QUALITY GATE: PASSED"
          echo "quality_gate_status=passed" >> $GITHUB_ENV
        else
          echo "âŒ QUALITY GATE: FAILED"
          echo "quality_gate_status=failed" >> $GITHUB_ENV
        fi
        echo "::endgroup::"

    - name: ğŸ“Š Quality Gate Summary
      run: |
        echo "## ğŸšª Quality Gate Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Overall Status:** ${{ env.quality_gate_status == 'passed' && 'âœ… PASSED' || 'âŒ FAILED' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Component Results:**" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ”¬ Quality Analysis: ${{ needs.quality-analysis.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ“ Type Coverage: ${{ needs.type-coverage-analysis.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ“¦ Dependency Analysis: ${{ needs.dependency-analysis.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "*For detailed reports, check the workflow artifacts.*" >> $GITHUB_STEP_SUMMARY

    - name: ğŸš« Fail on Quality Gate Failure
      if: env.quality_gate_status == 'failed'
      run: |
        echo "âŒ Quality gate failed - blocking merge"
        exit 1